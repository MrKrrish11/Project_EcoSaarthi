<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoSim: AI-Generated Events</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #0d0c22; /* Deep Indigo */
            color: #e0e7ff; /* Lavender */
        }
        .card {
            background: linear-gradient(145deg, rgba(45, 35, 99, 0.5), rgba(28, 25, 66, 0.5));
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-align: left;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: translateY(0);
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .btn-primary {
            background: linear-gradient(90deg, #f957a2, #ff8c7f);
            color: white;
        }
        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            color: #e0e7ff;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .progress-bar {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 9999px;
            overflow: hidden;
            height: 1.25rem;
        }
        .progress {
            background: linear-gradient(90deg, #8a2be2, #4a00e0);
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(13, 12, 34, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
        }
        .stat-label {
            font-size: 0.875rem;
            font-weight: 400;
            color: #a5b4fc; /* Lighter Lavender */
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .loader, .btn-loader {
            border: 4px solid rgba(255,255,255,0.2);
            border-top: 4px solid #f957a2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loader {
            width: 40px;
            height: 40px;
            margin: 20px auto;
        }
        .btn-loader {
            width: 20px;
            height: 20px;
            margin-right: 0.5rem;
        }
        input, select {
            background-color: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
            color: #e0e7ff;
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: border-color 0.3s ease;
        }
        input::placeholder {
            color: #a5b4fc;
        }
        .input-error {
            border-color: #f957a2 !important;
        }
        .btn-icon {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
            stroke-width: 2;
        }
        .btn-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            padding: 0;
            margin-left: auto;
            margin-right: auto;
        }
        .btn-red {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }
        .animate-flicker {
            animation: flicker 1.5s infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes flicker {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 5px #ef4444, 0 0 10px #ef4444, 0 0 20px #ef4444, inset 0 0 10px rgba(255, 100, 100, 0.5);
            }
            50% {
                opacity: 0.8;
                box-shadow: 0 0 5px #dc2626, 0 0 10px #dc2626, 0 0 15px #dc2626, inset 0 0 5px rgba(255, 50, 50, 0.5);
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="game-container" class="max-w-7xl mx-auto hidden">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between md:items-center mb-10 gap-6">
            <header class="text-center md:text-left">
                <h1 class="text-5xl font-bold text-white tracking-wider">ECOSIM</h1>
                <p id="journey-title" class="text-lg text-indigo-300"></p>
            </header>
            <div id="goal-card" class="card md:w-2/5 lg:w-1/3">
                <h2 id="goal-title" class="text-xl font-semibold mb-2 text-white">🎯 Financial Goal</h2>
                <p id="goal-description" class="text-indigo-300 mb-2 text-sm"></p>
                <div class="progress-bar w-full">
                    <div id="progress-bar" class="progress text-white text-xs font-medium flex items-center justify-center" style="width: 0%;">0%</div>
                </div>
            </div>
        </div>

        <!-- Main Game Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Stats & Actions -->
            <div class="lg:col-span-1 space-y-8">
                <div class="card">
                    <h2 class="text-2xl font-semibold mb-4 text-white">📊 Your Status</h2>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-6">
                        <div><p class="stat-label">Age</p><p id="age" class="stat-value text-white">22</p></div>
                        <div><p class="stat-label">Net Worth</p><p id="net-worth" class="stat-value text-white">$0</p></div>
                        <div><p class="stat-label">Bank Balance</p><p id="cash" class="stat-value text-green-400">$2,000</p></div>
                        <div><p class="stat-label">Investments</p><p id="investments" class="stat-value text-cyan-400">$0</p></div>
                        <div><p class="stat-label">Student Debt</p><p id="debt" class="stat-value text-red-400">$30,000</p></div>
                    </div>
                </div>
                 <div class="card">
                    <h2 class="text-2xl font-semibold mb-4 text-white">⚡ Actions</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-indigo-300">Manual Entry</label>
                            <div class="flex space-x-2 mt-1"><input type="number" id="invest-amount" class="w-full" placeholder="Amount"><button id="invest-btn" class="btn btn-secondary whitespace-nowrap">Invest</button></div>
                            <div class="flex space-x-2 mt-2"><input type="number" id="debt-amount" class="w-full" placeholder="Amount"><button id="pay-debt-btn" class="btn btn-secondary whitespace-nowrap">Pay Debt</button></div>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-indigo-300">Quick Actions</label>
                            <div class="grid grid-cols-2 gap-2 mt-1">
                                <button id="invest-100-btn" class="btn btn-secondary text-sm"><svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>Invest $100</button>
                                <button id="invest-500-btn" class="btn btn-secondary text-sm"><svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>Invest $500</button>
                                <button id="pay-debt-100-btn" class="btn btn-secondary text-sm"><svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01"></path></svg>Pay $100</button>
                                <button id="pay-debt-500-btn" class="btn btn-secondary text-sm"><svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01"></path></svg>Pay $500</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Log & Controls -->
            <div class="lg:col-span-2 space-y-8">
                <div class="card"><h2 class="text-2xl font-semibold mb-4 text-white">📜 Event Log</h2><div id="event-log" class="event-log p-3 rounded-md overflow-y-auto space-y-2"><p class="text-indigo-300">Welcome! Enter your details to begin.</p></div></div>
                <div class="card text-center bg-transparent border-none shadow-none p-0">
                    <button id="advance-month-btn" class="btn btn-primary w-full md:w-3/4 lg:w-1/2 text-lg py-3">
                        <span id="advance-btn-text">🚀 Start Next Month</span>
                        <div id="advance-btn-loader" class="btn-loader hidden"></div>
                    </button>
                    <button id="coach-btn" class="btn btn-secondary w-full md:w-3/4 lg:w-1/2 mt-4">✨ Get AI Financial Advice</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="welcome-modal" class="modal-backdrop"><div class="modal-content card text-center"><h2 class="text-3xl font-bold mb-4 text-white">Welcome to EcoSim!</h2><p class="text-indigo-300 mb-6">Let's personalize your journey. Tell us a bit about yourself.</p>
        <div class="space-y-4">
            <input type="text" id="player-name" placeholder="Enter your name" class="w-full text-center">
            <input type="number" id="player-age" placeholder="Enter your starting age" class="w-full text-center">
            <select id="goal-select" class="w-full text-center">
                <option value="" disabled selected>-- Select Your Goal --</option>
                <option value="debt">💸 Pay off $30,000 in student loans</option>
                <option value="emergency">🛡 Build a $10,000 Emergency Fund</option>
                <option value="car">🚗 Save $25,000 for a new car</option>
                <option value="house">🏡 Save $75,000 for a house down payment</option>
                <option value="invest100k">📈 Reach $100,000 in investments</option>
                <option value="retire">🏖 Build a net worth of $500,000</option>
            </select>
            <div id="welcome-error" class="text-red-400 text-sm mt-2 hidden"></div>
            <button id="start-game-btn" class="btn btn-primary w-full">Start Your Journey</button>
        </div>
    </div></div>
    <div id="choice-modal" class="modal-backdrop hidden"><div class="modal-content card"><h2 id="choice-title" class="text-2xl font-bold mb-2 text-white"></h2><p id="choice-description" class="text-indigo-300 mb-6"></p><div id="choice-buttons" class="space-y-3"></div></div></div>
    <div id="strategy-modal" class="modal-backdrop hidden"><div class="modal-content card text-center"><h2 id="strategy-title" class="text-2xl font-bold mb-4 text-white"></h2><div id="strategy-content"><p class="text-indigo-300 mb-6">Would you like some AI-powered advice to get started?</p><button id="generate-strategy-btn" class="btn btn-primary w-full">✨ Generate a Strategy</button></div><div id="strategy-loader" class="loader hidden"></div><div id="strategy-response" class="text-indigo-200 mt-4 hidden"></div><button id="close-strategy-btn" class="btn btn-circle btn-red animate-flicker mt-6">Let's Go!</button></div></div>
    <div id="coach-modal" class="modal-backdrop hidden"><div class="modal-content card"><h2 class="text-2xl font-bold mb-4 text-white">🤖 AI Financial Coach</h2><div id="coach-loader" class="loader"></div><div id="coach-response" class="text-indigo-200 hidden"></div><button id="close-coach-btn" class="btn btn-secondary w-full mt-6">Got it, thanks!</button></div></div>
    <div id="game-over-modal" class="modal-backdrop hidden"><div class="modal-content card text-center"><h2 id="game-over-title" class="text-3xl font-bold mb-4"></h2><p id="game-over-message" class="text-indigo-300 mb-6"></p><button onclick="window.location.reload()" class="btn btn-primary">Play Again</button></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GAME STATE ---
            const gameState = { playerName: 'Player', age: 22, cash: 2000, investments: 0, debt: 30000, monthlyIncome: 3500, monthlyExpenses: { rent: 1200, food: 400, utilities: 200, transport: 150, fun: 250 }, goal: { type: null, target: 0, title: '', description: '' }, isGameOver: false };

            // --- UI ELEMENTS ---
            const ui = {
                age: document.getElementById('age'), netWorth: document.getElementById('net-worth'), cash: document.getElementById('cash'), investments: document.getElementById('investments'), debt: document.getElementById('debt'),
                goalTitle: document.getElementById('goal-title'), goalDescription: document.getElementById('goal-description'), progressBar: document.getElementById('progress-bar'), eventLog: document.getElementById('event-log'),
                investAmountInput: document.getElementById('invest-amount'), debtAmountInput: document.getElementById('debt-amount'), investBtn: document.getElementById('invest-btn'), payDebtBtn: document.getElementById('pay-debt-btn'),
                invest100Btn: document.getElementById('invest-100-btn'), invest500Btn: document.getElementById('invest-500-btn'), payDebt100Btn: document.getElementById('pay-debt-100-btn'), payDebt500Btn: document.getElementById('pay-debt-500-btn'),
                advanceMonthBtn: document.getElementById('advance-month-btn'), advanceBtnText: document.getElementById('advance-btn-text'), advanceBtnLoader: document.getElementById('advance-btn-loader'),
                gameContainer: document.getElementById('game-container'),
                welcomeModal: document.getElementById('welcome-modal'), gameOverModal: document.getElementById('game-over-modal'), gameOverTitle: document.getElementById('game-over-title'), gameOverMessage: document.getElementById('game-over-message'),
                coachBtn: document.getElementById('coach-btn'), coachModal: document.getElementById('coach-modal'), coachLoader: document.getElementById('coach-loader'), coachResponse: document.getElementById('coach-response'), closeCoachBtn: document.getElementById('close-coach-btn'),
                strategyModal: document.getElementById('strategy-modal'), strategyTitle: document.getElementById('strategy-title'), strategyContent: document.getElementById('strategy-content'), strategyLoader: document.getElementById('strategy-loader'), strategyResponse: document.getElementById('strategy-response'), generateStrategyBtn: document.getElementById('generate-strategy-btn'), closeStrategyBtn: document.getElementById('close-strategy-btn'),
                choiceModal: document.getElementById('choice-modal'), choiceTitle: document.getElementById('choice-title'), choiceDescription: document.getElementById('choice-description'), choiceButtons: document.getElementById('choice-buttons'),
                playerNameInput: document.getElementById('player-name'), playerAgeInput: document.getElementById('player-age'), goalSelect: document.getElementById('goal-select'), startGameBtn: document.getElementById('start-game-btn'), journeyTitle: document.getElementById('journey-title'),
                welcomeError: document.getElementById('welcome-error'),
            };

            // --- STATIC FALLBACK EVENTS ---
            const staticChoiceEvents = [
                {
                    title: "🧘 A Quiet Month",
                    description: "Nothing out of the ordinary happened this month. A good time to focus on your goals.",
                    choices: [
                        { text: "Stick to the budget.", effect: { cash: 0, investments: 0, debt: 0, log: { title: "Steady Progress", message: "You stayed disciplined this month.", color: "slate" }}},
                        { text: "Make an extra debt payment of $250.", effect: { cash: -250, investments: 0, debt: -250, log: { title: "Extra Payment", message: "You paid an extra $250 on your debt.", color: "green" }}},
                        { text: "Invest an extra $250.", effect: { cash: -250, investments: 250, debt: 0, log: { title: "Extra Investment", message: "You invested an extra $250.", color: "cyan" }}},
                    ]
                }
            ];

            // --- HELPER FUNCTIONS ---
            const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 }).format(amount);
            const logEvent = (title, message, color = 'gray') => {
                const p = document.createElement('p');
                const colorMap = { green: 'text-green-400', red: 'text-red-400', cyan: 'text-cyan-400', slate: 'text-indigo-300' };
                const textColor = colorMap[color] || 'text-gray-300';
                p.innerHTML = `<strong class="${textColor}">${title}</strong>: ${message}`;
                ui.eventLog.prepend(p);
                if (ui.eventLog.children.length > 20) ui.eventLog.lastChild.remove();
            };

            // --- GEMINI API INTEGRATION ---
            const API_KEY = ""; // IMPORTANT: REPLACE WITH YOUR ACTUAL API KEY
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
            
            async function callGemini(prompt, isJson = false) {
                if (!API_KEY) {
                    console.error("API Key is not set. AI features will be disabled.");
                    logEvent("⚠️ AI Offline", "API Key not provided. Using fallback data.", "red");
                    return null;
                }
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                if (isJson) {
                    payload.generationConfig = {
                        responseMimeType: "application/json",
                    };
                }

                let attempt = 0;
                while (attempt < 3) {
                    try {
                        const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                        const result = await response.json();
                        if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                            const text = result.candidates[0].content.parts[0].text;
                            return isJson ? JSON.parse(text) : text;
                        } else { throw new Error("Invalid response structure from API."); }
                    } catch (error) {
                        console.error("Gemini API call failed:", error);
                        attempt++;
                        if (attempt >= 3) return null;
                        await new Promise(res => setTimeout(res, Math.pow(2, attempt) * 1000));
                    }
                }
            }
            
            async function generateAiChoiceEvent() {
                const prompt = `You are an event generator for a financial simulation game. The player's name is ${gameState.playerName}, age ${Math.floor(gameState.age)}.
                Current state: Cash: ${formatCurrency(gameState.cash)}, Investments: ${formatCurrency(gameState.investments)}, Debt: ${formatCurrency(gameState.debt)}.
                Their goal is: ${gameState.goal.title}.
                Create a unique, interesting, and realistic financial event with 2-3 choices. The event can be positive, negative, or a dilemma.
                The choices should have clear consequences on the player's finances (cash, investments, debt).
                Return ONLY a valid JSON object with the following structure: { "title": "string", "description": "string", "choices": [{ "text": "string", "effect": { "cash": number, "investments": number, "debt": number, "log": { "title": "string", "message": "string", "color": "string" } } }] }.
                The "effect" values should be numbers representing the change (e.g., -500 for a $500 cost).
                The log color should be 'green' for positive outcomes, 'red' for negative, 'cyan' for investments, or 'slate' for neutral.`;
                
                return await callGemini(prompt, true);
            }

            // --- CORE GAME LOGIC ---
            function init() {
                ui.startGameBtn.addEventListener('click', handleStartGame);
                ui.investBtn.addEventListener('click', () => handleInvestment());
                ui.payDebtBtn.addEventListener('click', () => handleDebtPayment());
                ui.invest100Btn.addEventListener('click', () => handleInvestment(100));
                ui.invest500Btn.addEventListener('click', () => handleInvestment(500));
                ui.payDebt100Btn.addEventListener('click', () => handleDebtPayment(100));
                ui.payDebt500Btn.addEventListener('click', () => handleDebtPayment(500));
                ui.advanceMonthBtn.addEventListener('click', presentChoice);
                ui.coachBtn.addEventListener('click', showCoachAdvice);
                ui.closeCoachBtn.addEventListener('click', () => ui.coachModal.classList.add('hidden'));
                ui.generateStrategyBtn.addEventListener('click', showStarterStrategy);
                ui.closeStrategyBtn.addEventListener('click', () => {
                    ui.strategyModal.classList.add('hidden');
                    ui.gameContainer.classList.remove('hidden');
                    updateUI();
                });
            }

            function handleStartGame() {
                ui.playerNameInput.classList.remove('input-error'); ui.playerAgeInput.classList.remove('input-error'); ui.goalSelect.classList.remove('input-error'); ui.welcomeError.classList.add('hidden');
                const name = ui.playerNameInput.value.trim(); const age = parseInt(ui.playerAgeInput.value); const goal = ui.goalSelect.value;
                let isValid = true; let errorMessage = '';
                if (!name) { ui.playerNameInput.classList.add('input-error'); isValid = false; errorMessage = 'Please enter your name.'; }
                if (!age) { ui.playerAgeInput.classList.add('input-error'); isValid = false; errorMessage = 'Please enter your age.'; } 
                else if (age < 18 || age > 60) { ui.playerAgeInput.classList.add('input-error'); isValid = false; errorMessage = 'Please enter an age between 18 and 60.'; }
                if (!goal) { ui.goalSelect.classList.add('input-error'); isValid = false; errorMessage = 'Please select a goal.'; }
                if (!isValid) { ui.welcomeError.textContent = errorMessage; ui.welcomeError.classList.remove('hidden'); return; }
                gameState.playerName = name; gameState.age = age;
                setGoal(goal);
                ui.welcomeModal.classList.add('hidden'); ui.strategyModal.classList.remove('hidden');
                ui.journeyTitle.textContent = `${gameState.playerName}'s Financial Journey`;
                logEvent("👋 Welcome, " + gameState.playerName + "!", "Your journey begins now. Good luck!", "cyan");
            }

            async function presentChoice() {
                if (gameState.isGameOver) return;
                
                setAdvanceButtonLoading(true);
                let event = await generateAiChoiceEvent();
                setAdvanceButtonLoading(false);

                if (!event || !event.choices || event.choices.length === 0) {
                    logEvent("Signal Lost...", "AI event generator is offline. Using a standard scenario.", "red");
                    event = staticChoiceEvents[0];
                } else {
                    logEvent("✨ AI Event!", "A unique event has occurred.", "cyan");
                }
                
                ui.choiceTitle.textContent = event.title;
                ui.choiceDescription.textContent = event.description;
                ui.choiceButtons.innerHTML = ''; 
                event.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.textContent = choice.text;
                    button.className = 'btn btn-secondary w-full';
                    button.onclick = () => {
                        applyChoiceEffect(choice.effect);
                        ui.choiceModal.classList.add('hidden');
                        finishMonth();
                    };
                    ui.choiceButtons.appendChild(button);
                });
                ui.choiceModal.classList.remove('hidden');
            }
            
            function applyChoiceEffect(effect) {
                if (!effect) return;
                gameState.cash += effect.cash || 0;
                gameState.investments += effect.investments || 0;
                gameState.debt += effect.debt || 0;
                if (effect.log) {
                    logEvent(effect.log.title, effect.log.message, effect.log.color);
                }
            }

            function setAdvanceButtonLoading(isLoading) {
                if (isLoading) {
                    ui.advanceBtnText.classList.add('hidden');
                    ui.advanceBtnLoader.classList.remove('hidden');
                    ui.advanceMonthBtn.disabled = true;
                } else {
                    ui.advanceBtnText.classList.remove('hidden');
                    ui.advanceBtnLoader.classList.add('hidden');
                    ui.advanceMonthBtn.disabled = false;
                }
            }

            function setGoal(type) { 
                gameState.goal.type = type; 
                if (type === 'debt') { 
                    gameState.goal.target = 0; 
                    gameState.goal.title = 'Goal: Pay Off Debt'; 
                    gameState.goal.description = 'Eliminate your $30,000 student loan.'; 
                } else if (type === 'emergency') {
                    gameState.goal.target = 10000;
                    gameState.goal.title = 'Goal: Build Emergency Fund';
                    gameState.goal.description = 'Save $10,000 in cash for unexpected events.';
                } else if (type === 'car') {
                    gameState.goal.target = 25000;
                    gameState.goal.title = 'Goal: Buy a New Car';
                    gameState.goal.description = 'Save up $25,000 to purchase a new vehicle.';
                } else if (type === 'house') {
                    gameState.goal.target = 75000;
                    gameState.goal.title = 'Goal: House Down Payment';
                    gameState.goal.description = 'Save $75,000 for a down payment on your first home.';
                } else if (type === 'invest100k') {
                    gameState.goal.target = 100000;
                    gameState.goal.title = 'Goal: Investment Milestone';
                    gameState.goal.description = 'Grow your investment portfolio to $100,000.';
                } else if (type === 'retire') { 
                    gameState.goal.target = 500000; 
                    gameState.goal.title = 'Goal: Early Retirement'; 
                    gameState.goal.description = 'Grow your net worth to $500,000.'; 
                } 
                ui.strategyTitle.textContent = `🎯 Strategy for: ${gameState.goal.title.split(': ')[1]}`; 
            }
            
            function updateUI() { 
                const netWorth = gameState.cash + gameState.investments - gameState.debt; 
                ui.age.textContent = Math.floor(gameState.age); 
                ui.netWorth.textContent = formatCurrency(netWorth); 
                ui.cash.textContent = formatCurrency(gameState.cash); 
                ui.investments.textContent = formatCurrency(gameState.investments); 
                ui.debt.textContent = formatCurrency(gameState.debt); 
                ui.goalTitle.textContent = `🎯 ${gameState.goal.title}`; 
                ui.goalDescription.textContent = gameState.goal.description; 
                let progress = 0; 
                if (gameState.goal.type === 'debt') {
                    progress = (30000 - gameState.debt) / 30000; 
                } else if (gameState.goal.type === 'retire') {
                    progress = netWorth / gameState.goal.target; 
                } else if (gameState.goal.type === 'emergency' || gameState.goal.type === 'car' || gameState.goal.type === 'house') {
                    progress = gameState.cash / gameState.goal.target;
                } else if (gameState.goal.type === 'invest100k') {
                    progress = gameState.investments / gameState.goal.target;
                }
                progress = Math.max(0, Math.min(1, progress)); 
                ui.progressBar.style.width = `${progress * 100}%`; 
                ui.progressBar.textContent = `${Math.floor(progress * 100)}%`; 
            }

            function checkGameOver() { 
                const netWorth = gameState.cash + gameState.investments - gameState.debt; 
                let isWin = false; 
                let winTitle = "🏆 Goal Achieved! 🏆";
                let winMessage = "";

                if (gameState.goal.type === 'debt' && gameState.debt <= 0) { 
                    isWin = true; 
                    winMessage = `Congratulations, ${gameState.playerName}! You paid off all your student debt at age ${Math.floor(gameState.age)}.`;
                } else if (gameState.goal.type === 'emergency' && gameState.cash >= gameState.goal.target) {
                    isWin = true; 
                    winMessage = `You've built your ${formatCurrency(gameState.goal.target)} emergency fund! You're prepared for anything.`;
                } else if (gameState.goal.type === 'car' && gameState.cash >= gameState.goal.target) {
                    isWin = true;
                    winMessage = `You saved ${formatCurrency(gameState.goal.target)}! Time to go car shopping, ${gameState.playerName}!`;
                } else if (gameState.goal.type === 'house' && gameState.cash >= gameState.goal.target) {
                    isWin = true;
                    winMessage = `Incredible! You've saved ${formatCurrency(gameState.goal.target)} for a down payment at age ${Math.floor(gameState.age)}.`;
                } else if (gameState.goal.type === 'invest100k' && gameState.investments >= gameState.goal.target) {
                    isWin = true;
                    winMessage = `You've become a savvy investor, reaching ${formatCurrency(gameState.goal.target)} in your portfolio!`;
                } else if (gameState.goal.type === 'retire' && netWorth >= gameState.goal.target) { 
                    isWin = true; 
                    winTitle = "🏆 You're Retired! 🏆";
                    winMessage = `With a net worth of ${formatCurrency(netWorth)}, you can retire early at age ${Math.floor(gameState.age)}!`;
                } 

                if (isWin) {
                    showGameOver(true, winTitle, winMessage);
                } else if (gameState.cash < 0 && netWorth < -10000) { 
                    showGameOver(false, "Game Over", `You've gone bankrupt. Better luck next time, ${gameState.playerName}!`); 
                } 
            }

            function finishMonth() { 
                if (gameState.isGameOver) return;
                gameState.age += 1/12; 
                gameState.cash += gameState.monthlyIncome; 
                const totalExpenses = Object.values(gameState.monthlyExpenses).reduce((a, b) => a + b, 0); 
                gameState.cash -= totalExpenses; 
                logEvent("Month End", `Paycheck received, expenses paid. Net: ${formatCurrency(gameState.monthlyIncome - totalExpenses)}.`, 'slate'); 
                if (gameState.debt > 0) {
                    const interest = gameState.debt * (0.05 / 12); 
                    gameState.debt += interest; 
                    gameState.cash -= interest; 
                    logEvent("Debt Interest 📉", `Paid ${formatCurrency(interest)} in loan interest.`, "red"); 
                }
                if (gameState.investments > 0) { 
                    const growthRate = (Math.random() - 0.4) * 0.1 + 0.005; 
                    const growthAmount = gameState.investments * growthRate; 
                    gameState.investments += growthAmount; 
                    const growthMsg = growthAmount >= 0 ? `Portfolio grew by ${formatCurrency(growthAmount)}.` : `Portfolio lost ${formatCurrency(Math.abs(growthAmount))}.`; 
                    logEvent(`Investment Update ${growthAmount >= 0 ? '📈' : '📉'}`, growthMsg, growthAmount >= 0 ? 'green' : 'red'); 
                } 
                updateUI(); 
                checkGameOver(); 
            }
            function handleInvestment(fixedAmount) { 
                if (gameState.isGameOver) return;
                const amount = fixedAmount || parseInt(ui.investAmountInput.value); 
                if (isNaN(amount) || amount <= 0) { logEvent("Invalid Action", "Please enter a positive amount.", "red"); return; } 
                if (amount > gameState.cash) { logEvent("Insufficient Funds 🛑", "Not enough cash.", "red"); return; } 
                gameState.cash -= amount; 
                gameState.investments += amount; 
                logEvent("Investment Made 💰", `You invested ${formatCurrency(amount)}.`, "cyan"); 
                ui.investAmountInput.value = ''; 
                updateUI(); 
            }
            function handleDebtPayment(fixedAmount) { 
                if (gameState.isGameOver) return;
                const amount = fixedAmount || parseInt(ui.debtAmountInput.value); 
                if (isNaN(amount) || amount <= 0) { logEvent("Invalid Action", "Please enter a positive amount.", "red"); return; } 
                if (amount > gameState.cash) { logEvent("Insufficient Funds 🛑", "Not enough cash.", "red"); return; } 
                const actualPayment = Math.min(amount, gameState.debt); 
                gameState.cash -= actualPayment; 
                gameState.debt -= actualPayment; 
                logEvent("Debt Payment ✅", `You paid ${formatCurrency(actualPayment)} towards your debt.`, "green"); 
                ui.debtAmountInput.value = ''; 
                updateUI();
                checkGameOver();
            }
            async function showStarterStrategy() { 
                ui.strategyContent.classList.add('hidden'); 
                ui.strategyLoader.classList.remove('hidden'); 
                const prompt = `I'm playing a financial simulation game. My name is ${gameState.playerName} and I'm ${gameState.age} years old. My chosen goal is to "${gameState.goal.description}". My starting situation is $2000 cash, $30000 debt, and a $3500 monthly income. Give me a simple, encouraging, high-level strategy to follow. Keep it to 2-3 short paragraphs. Use a cool, futuristic tone with emojis.`; 
                const advice = await callGemini(prompt) || "Alright, pilot! Your mission: conquer your goal. Keep a tight grip on your monthly budget—know where every credit is going. Automate your savings and investments right after your paycheck hits. Even small, consistent contributions build massive empires over time. Stay focused, adapt to challenges, and the financial galaxy is yours! 🚀";
                ui.strategyLoader.classList.add('hidden'); 
                ui.strategyResponse.innerHTML = advice.replace(/\n/g, '<br>'); 
                ui.strategyResponse.classList.remove('hidden'); 
            }
            async function showCoachAdvice() { 
                ui.coachModal.classList.remove('hidden'); 
                ui.coachResponse.classList.add('hidden'); 
                ui.coachLoader.classList.remove('hidden'); 
                const prompt = `I'm playing a financial simulation game with a futuristic neon theme. My name is ${gameState.playerName}. Here's my current status: - Age: ${Math.floor(gameState.age)} - Cash: ${formatCurrency(gameState.cash)} - Investments: ${formatCurrency(gameState.investments)} - Debt: ${formatCurrency(gameState.debt)} - My Goal: ${gameState.goal.title} (${gameState.goal.description}) Based on this, what is one piece of actionable advice you would give me for my next move? Keep it concise (1-2 paragraphs) and encouraging. Use a cool, futuristic tone with emojis.`; 
                const advice = await callGemini(prompt) || "Greetings, data-streamer! Analyzing your financial matrix... Your next optimal move is to focus on [insert relevant advice here, e.g., 'crushing that high-interest debt' or 'boosting your investment allocation']. Stay sharp! ✨";
                ui.coachLoader.classList.add('hidden'); 
                ui.coachResponse.innerHTML = advice.replace(/\n/g, '<br>'); 
                ui.coachResponse.classList.remove('hidden'); 
            }
            function showGameOver(isWin, title, message) { 
                gameState.isGameOver = true; 
                ui.gameOverTitle.textContent = title; 
                ui.gameOverMessage.textContent = message; 
                ui.gameOverTitle.classList.add(isWin ? 'text-green-400' : 'text-red-400'); 
                ui.gameOverModal.classList.remove('hidden'); 
                setAdvanceButtonLoading(true); // Disable further play
            }

            // --- START THE GAME ---
            init();
        });
    </script>
</body>
</html>